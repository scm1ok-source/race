<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Гоночная сессия — прогресс по командам</title>
<style>
:root{
  --card:#f7f8fb; --text:#0f172a; --muted:#475569; --line:#e2e8f0; --accent:#d61f1f; --shadow:0 6px 18px rgba(15,23,42,.08);
  --row-gap:10px; --row-pad-v:12px;
  /* 7 цветов */
  --c1:#ff0000; --c2:#ffd700; --c3:#0066ff; --c4:#00ced1; --c5:#7fff00; --c6:#8b4513; --c7:#000000;
}
*{box-sizing:border-box}
body{margin:0;background:#fff;color:var(--text);font:500 16px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1200px;margin:16px auto;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line)}
.header h1{margin:0;font-size:20px}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button{background:#fff;border:1px solid #dbe3ee;color:var(--text);border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.15s}
button:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(15,23,42,.06)}
button.primary{background:#d61f1f;border-color:#c11212;color:#fff}
.small{padding:6px 10px;border-radius:10px;font-size:12px}

/* макет 1/3–2/3 */
.grid{display:grid;grid-template-columns:1fr 2fr;gap:12px;padding:12px}
@media(max-width:960px){.grid{grid-template-columns:1fr}}

/* панель этапа */
.flag{display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 10px}
.stage-pill{padding:4px 10px;border-radius:999px;background:transparent;border:none;font-weight:700;color:var(--text)}
.timer{font-variant-numeric:tabular-nums;font-size:20px}

/* таблица слева */
.badge{width:14px;height:14px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.table{width:100%;border-collapse:separate;border-spacing:0 var(--row-gap)}
.table thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
.row{display:grid;grid-template-columns:minmax(120px,1fr) 48px 1fr;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
.name{display:flex;align-items:center;gap:8px;font-weight:700;font-size:14px}
.pos{text-align:center;font-weight:700}
.progressCell{display:flex;flex-direction:column;align-items:flex-start;gap:4px}
.pointsBox input{width:80px;padding:6px 8px;border:1px solid #dbe3ee;border-radius:8px;font-weight:700;text-align:right}
.hint{color:var(--muted);font-size:12px}

/* правая колонка — бары */
.stagePanel{padding:12px}
.chart-header{background:transparent;border:none;border-radius:0;padding:0 12px;display:flex;align-items:center;font-weight:800}
.chart-header h2{margin:0;font-size:18px}
.chart{margin-top:var(--row-gap)}
.chart-row{display:flex;align-items:center;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:var(--row-pad-v) 12px;margin-bottom:var(--row-gap)}
.chart-row:last-child{margin-bottom:0}
.meter{position:relative;flex:1;height:14px;background:#eef2f7;border:1px solid #e2e8f0;border-radius:999px;overflow:hidden}
.meter>span{display:block;height:100%;width:0;transition:width .5s ease}
.val{margin-left:10px;min-width:34px;text-align:right;font-variant-numeric:tabular-nums;font-weight:800}

/* footer */
.footer{padding:10px 12px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
.bonus{position:absolute;pointer-events:none;font-size:22px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
.container-relative{position:relative}
#bonusLayer{position:absolute;inset:0;pointer-events:none}
</style>
</head>
<body>
<div class="wrap card">
  <div class="header">
    <h1>Гоночная сессия • 7 команд</h1>
    <div class="flag">
      <span class="stage-pill" id="stageName">СТАРТ</span>
      <span class="timer" id="timer">00:00</span>
      <div class="controls">
        <button id="btnStart" class="primary">Старт</button>
        <button id="btnPause">Пауза</button>
        <button id="btnNext"  class="small">Следующий этап</button>
        <button id="btnUndo"  class="small">Отмена</button>
        <button id="btnRank"  class="small">Пересчитать позиции</button>
        <button id="btnHard"  class="small">Чистый сброс</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- Левая колонка -->
    <div class="section card container-relative">
      <table class="table" aria-live="polite">
        <thead><tr><th>Команда</th><th>#</th><th>Очки</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="bonusLayer"></div>
    </div>

    <!-- Правая колонка -->
    <div class="stagePanel card">
      <div id="chartHeader" class="chart-header"><h2 id="stageTitle">СТАРТ</h2></div>
      <div id="stageChart" class="chart"></div>
    </div>
  </div>

  <div class="footer"><div>© Формула обучения — лёгкий старт, честный финиш.</div></div>
</div>

<script>
(()=>{"use strict";
/* === Конфигурация === */
const STORAGE_KEY="race_state_vfinal_sync";
const COLORS=["var(--c1)","var(--c2)","var(--c3)","var(--c4)","var(--c5)","var(--c6)","var(--c7)"];
const DEFAULT_NAMES=["Porsche","Lamborghini","Williams","Lotus","Aston Martin","McLaren","Alfa Romeo"];
const STAGES=[{name:"СТАРТ",sec:0},{name:"ЗАЕЗД 1",sec:120},{name:"ЗАЕЗД 3",sec:480},{name:"ФИНИШ",sec:0}];

const $=s=>document.querySelector(s);
const tbody=$("#tbody"), stageName=$("#stageName"), timerEl=$("#timer");
const btnStart=$("#btnStart"), btnPause=$("#btnPause"), btnNext=$("#btnNext"), btnUndo=$("#btnUndo"), btnHard=$("#btnHard"), btnRank=$("#btnRank");
const stageChart=$("#stageChart"), stageTitle=$("#stageTitle"), bonusLayer=$("#bonusLayer"), chartHeader=$("#chartHeader");

function fresh(){
  return {teams:DEFAULT_NAMES.map((n,i)=>({id:i,name:n,color:COLORS[i],pts:0})),
          order:[0,1,2,3,4,5,6], stage:0, remain:STAGES[0].sec, history:[]};
}
function load(){
  try{
    const d=JSON.parse(localStorage.getItem(STORAGE_KEY)||"null");
    if(!d||!Array.isArray(d.teams)||d.teams.length!==DEFAULT_NAMES.length) return fresh();
    d.teams=d.teams.map((t,i)=>({id:i,name:DEFAULT_NAMES[i],color:COLORS[i],pts:Number(t?.pts)||0}));
    if(!Array.isArray(d.order)||d.order.length!==d.teams.length) d.order=d.teams.map(t=>t.id);
    if(typeof d.stage!=="number") d.stage=0;
    if(typeof d.remain!=="number") d.remain=STAGES[d.stage].sec;
    if(!Array.isArray(d.history)) d.history=[];
    return d;
  }catch{return fresh()}
}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state))}
let state=load(); let running=false; let last=performance.now();

/* Утилиты */
const fmt=s=>{s=Math.max(0,s|0);return String((s/60|0)).padStart(2,"0")+":"+String(s%60|0).padStart(2,"0")};
const teamsByOrder=()=>state.order.map(id=>state.teams.find(t=>t.id===id));
const leaderPts=()=>Math.max(1,...state.teams.map(t=>t.pts),1);
function flare(hostEl,emoji){
  const r=hostEl.getBoundingClientRect(),h=bonusLayer.getBoundingClientRect();
  const b=document.createElement("div"); b.className="bonus"; b.textContent=emoji;
  b.style.left=(r.left-h.left+r.width-60)+"px"; b.style.top=(r.top-h.top-8)+"px";
  bonusLayer.appendChild(b);
  b.animate([{transform:"translateY(0)",opacity:1},{transform:"translateY(-26px)",opacity:0}],{duration:650,easing:"ease-out"}).onfinish=()=>b.remove();
}

/* СИНХРОНИЗАЦИЯ ВЫСОТ */
function syncHeaderHeight(){
  const thead=document.querySelector(".table thead");
  const h=thead?thead.getBoundingClientRect().height:0;
  chartHeader.style.height=h+"px";
}
function syncRowHeights(){
  const left=[...document.querySelectorAll("#tbody .row")];
  const right=[...document.querySelectorAll("#stageChart .chart-row")];
  const padV=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--row-pad-v"))||12;
  right.forEach((r,i)=>{
    const lh=left[i]?.offsetHeight||56;
    r.style.height=lh+"px";
    const meter=r.querySelector(".meter");
    meter.style.height=Math.max(10, lh - padV*2) + "px";
    meter.style.borderRadius=(lh/2)+"px";
  });
}

/* Левая колонка */
function updateBoard(){
  const ordered=teamsByOrder();
  tbody.innerHTML="";
  ordered.forEach((t,idx)=>{
    const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=3;
    const row=document.createElement("div"); row.className="row";

    const name=document.createElement("div"); name.className="name";
    const dot=document.createElement("span"); dot.className="badge"; dot.style.background=t.color;
    const title=document.createElement("span"); title.textContent=t.name;
    name.append(dot,title);

    const pos=document.createElement("div"); pos.className="pos"; pos.textContent=idx+1;

    const cell=document.createElement("div"); cell.className="progressCell";
    const box=document.createElement("div"); box.className="pointsBox";
    const inp=document.createElement("input"); inp.type="number"; inp.step="1"; inp.placeholder="0";
    inp.addEventListener("keydown",e=>{
      if(e.key==="Enter"){ applyDelta(t, parseInt(inp.value||"0",10)||0, row); inp.value=""; }
    });
    const hint=document.createElement("div"); hint.className="hint"; hint.textContent="Введите баллы и Enter";
    box.append(inp); cell.append(box,hint);

    row.append(name,pos,cell); td.appendChild(row); tr.appendChild(td); tbody.appendChild(tr);
  });
}

/* Правая колонка */
function updateChart(){
  stageTitle.textContent=STAGES[state.stage].name;
  const ordered=teamsByOrder(); const lead=leaderPts();
  stageChart.innerHTML="";
  ordered.forEach(t=>{
    const row=document.createElement("div"); row.className="chart-row";
    const m=document.createElement("div"); m.className="meter";
    const f=document.createElement("span"); f.style.background=t.color; f.style.width=(t.pts/lead*100).toFixed(1)+"%"; m.appendChild(f);
    const v=document.createElement("div"); v.className="val"; v.textContent=t.pts;
    row.append(m,v); stageChart.appendChild(row);
  });
  // критично: выровнять заголовок и строки по высоте
  syncHeaderHeight(); syncRowHeights();
}

/* Очки и порядок */
function applyDelta(team, delta, rowEl){
  if(!delta) return;
  team.pts=Math.max(0,team.pts+delta);
  state.history.push({ts:Date.now(),id:team.id,delta,stage:state.stage});
  save(); render();
  flare(rowEl,"⚡");
}
function recalcOrder(){
  const prevOrder=state.order.slice();
  const byIdIndex=Object.fromEntries(prevOrder.map((id,i)=>[id,i]));
  const sortedIds=state.teams.map(t=>t.id).sort((a,b)=>{
    const ta=state.teams[a],tb=state.teams[b];
    if(tb.pts!==ta.pts) return tb.pts-ta.pts;
    return byIdIndex[a]-byIdIndex[b];
  });
  state.order=sortedIds; save(); render();
}

/* Таймер/управление */
function undo(){const h=state.history.pop();if(!h)return;const t=state.teams.find(x=>x.id===h.id);if(t)t.pts=Math.max(0,t.pts-h.delta);save();render();}
function next(){if(state.stage<STAGES.length-1){state.stage++;state.remain=STAGES[state.stage].sec;running=false;btnStart.disabled=false;save();render();}}
function hard(){if(confirm("Обнулить все результаты и перезапустить?")){localStorage.removeItem(STORAGE_KEY);location.reload();}}

let tickLast=performance.now();
function tick(now){if(!running)return;if(now-tickLast>=1000){state.remain--;tickLast=now;timerEl.textContent=fmt(state.remain);if(state.remain<=0){running=false;btnStart.disabled=false;}save();}requestAnimationFrame(tick);}
function start(){if(STAGES[state.stage].name==="ФИНИШ")return;running=true;btnStart.disabled=true;tickLast=performance.now();requestAnimationFrame(tick);}
function pause(){running=false;btnStart.disabled=false;}

/* Рендер и инициализация */
function render(){
  stageName.textContent=STAGES[state.stage].name;
  timerEl.textContent=fmt(state.remain);
  updateBoard(); updateChart();
}
function boot(){
  render();
  btnStart.onclick=start; btnPause.onclick=pause; btnNext.onclick=next; btnUndo.onclick=undo; btnHard.onclick=hard; btnRank.onclick=recalcOrder;
  // пересинхронизация при ресайзе / изменении шрифтов
  window.addEventListener("resize",()=>{syncHeaderHeight(); syncRowHeights();});
  // немного отложенная синхронизация после первого рендера (на случай поздней отрисовки шрифтов)
  setTimeout(()=>{syncHeaderHeight(); syncRowHeights();}, 50);
}
document.readyState==="loading"?document.addEventListener("DOMContentLoaded",boot):boot();
})();
</script>
</body>
</html>
