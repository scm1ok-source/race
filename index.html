<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ì–æ–Ω–æ—á–Ω–∞—è —Å–µ—Å—Å–∏—è ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º</title>
<style>
:root{
  --card:#f7f8fb; --text:#0f172a; --muted:#475569; --line:#e2e8f0; --accent:#d61f1f; --shadow:0 6px 18px rgba(15,23,42,.08);
  --c1:#e11d48; --c2:#16a34a; --c3:#2563eb; --c4:#7c3aed; --c5:#ea580c; --c6:#db2777; --c7:#0891b2;
  --row-gap:10px; --row-pad-v:12px; /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã chart-row */
}
*{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#fff,#fafbff 55%,#f5f7fb);color:var(--text);font:500 16px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1200px;margin:16px auto;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line)}
.header h1{margin:0;font-size:20px}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button{background:#fff;border:1px solid #dbe3ee;color:var(--text);border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.15s}
button:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(15,23,42,.06)}
button.primary{background:#d61f1f;border-color:#c11212;color:#fff}
.small{padding:6px 10px;border-radius:10px;font-size:12px}

/* –õ—ç–π–∞—É—Ç: –ª–µ–≤–∞—è 1/3, –ø—Ä–∞–≤–∞—è 2/3 */
.grid{display:grid;grid-template-columns:1fr 2fr;gap:12px;padding:12px}
@media(max-width:960px){.grid{grid-template-columns:1fr}}

/* –®–∞–ø–∫–∞ —ç—Ç–∞–ø–∞ */
.flag{display:flex;gap:10px;align-items:center;background:#ffffff;border:1px solid var(--line);border-radius:12px;padding:8px 10px}
.stage-pill{padding:4px 10px;border-radius:999px;background:#eef2ff;border:1px solid #dbe3ff}
.stage-pill strong{color:#1d4ed8}
.timer{font-variant-numeric:tabular-nums;font-size:20px}

/* –¢–∞–±–ª–∏—Ü–∞ —Å–ª–µ–≤–∞ */
.badge{width:14px;height:14px;border-radius:50%;border:2px solid #ffffffb3;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.table{width:100%;border-collapse:separate;border-spacing:0 var(--row-gap)}
.table thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
.row{display:grid;grid-template-columns:minmax(120px,1fr) 48px 1fr;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
.name{display:flex;align-items:center;gap:8px;font-weight:700;font-size:14px}
.pos{text-align:center;font-variant-numeric:tabular-nums;font-weight:700}
.progressCell{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:10px}
.btns{display:grid;grid-template-columns:repeat(2, max-content);gap:6px} /* 2 –≤ —Ä—è–¥ */
.btns .small{padding:4px 8px;border-radius:8px}
.pbar{height:12px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;overflow:hidden}
.pbar>span{display:block;height:100%;width:0;transition:width .5s ease}

/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
.stagePanel{padding:12px}
.chart-header{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:0 12px;display:flex;align-items:center;font-weight:800}
.chart-header h2{margin:0;font-size:18px}
.chart{margin-top:var(--row-gap)}
.chart-row{display:flex;align-items:center;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:var(--row-pad-v) 12px;margin-bottom:var(--row-gap)}
.chart-row:last-child{margin-bottom:0}
.meter{position:relative;flex:1;height:14px;background:#eef2f7;border:1px solid #e2e8f0;border-radius:999px;overflow:hidden}
.meter>span{display:block;height:100%;width:0;transition:width .5s ease}
.val{margin-left:10px;min-width:34px;text-align:right;font-variant-numeric:tabular-nums;font-weight:800}

/* –ü—Ä–æ—á–µ–µ */
.footer{padding:10px 12px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px}
.hidden{display:none}
.bonus{position:absolute;pointer-events:none;font-size:22px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
.container-relative{position:relative}
#bonusLayer{position:absolute;inset:0;pointer-events:none}
</style>
</head>
<body>
<div class="wrap card">
  <div class="header">
    <h1>–ì–æ–Ω–æ—á–Ω–∞—è —Å–µ—Å—Å–∏—è ‚Ä¢ 7 –∫–æ–º–∞–Ω–¥</h1>
    <div class="flag">
      <span class="stage-pill">–≠—Ç–∞–ø: <strong id="stageName">–°–¢–ê–†–¢</strong></span>
      <span class="timer" id="timer">05:00</span>
      <div class="controls">
        <button id="btnStart" class="primary">–°—Ç–∞—Ä—Ç</button>
        <button id="btnPause">–ü–∞—É–∑–∞</button>
        <button id="btnNext" class="small">–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø</button>
        <button id="btnUndo" class="small">–û—Ç–º–µ–Ω–∞</button>
        <button id="btnHard" class="small">–ß–∏—Å—Ç—ã–π —Å–±—Ä–æ—Å</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (1/3): –ö–æ–º–∞–Ω–¥–∞ | # | –ü—Ä–æ–≥—Ä–µ—Å—Å -->
    <div class="section card container-relative">
      <table class="table" aria-live="polite">
        <thead><tr><th>–ö–æ–º–∞–Ω–¥–∞</th><th>#</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="bonusLayer"></div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (2/3): –ó–∞–≥–æ–ª–æ–≤–æ–∫ —ç—Ç–∞–ø–∞ + –±–∞—Ä—ã –Ω–∞ –≤—Å—é –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫–∏ -->
    <div class="stagePanel card">
      <div id="chartHeader" class="chart-header"><h2 id="stageTitle">–°–¢–ê–†–¢</h2></div>
      <div id="stageChart" class="chart"></div>
    </div>
  </div>

  <div class="footer"><div class="note">¬© –§–æ—Ä–º—É–ª–∞ –æ–±—É—á–µ–Ω–∏—è ‚Äî –ª—ë–≥–∫–∏–π —Å—Ç–∞—Ä—Ç, —á–µ—Å—Ç–Ω—ã–π —Ñ–∏–Ω–∏—à.</div></div>
</div>

<script>
(()=>{"use strict";
/* === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è/—Å–æ—Å—Ç–æ—è–Ω–∏–µ === */
const STORAGE_KEY="race_bars_state_clean_1";
const COLORS=["var(--c1)","var(--c2)","var(--c3)","var(--c4)","var(--c5)","var(--c6)","var(--c7)"];
const TEAM_NAMES=["Ferrum","Aquila","Volt","Nebula","Ignite","Blossom","Glacier"];
const STAGES=[{name:"–°–¢–ê–†–¢",sec:300},{name:"–ó–ê–ï–ó–î 1",sec:600},{name:"–ó–ê–ï–ó–î 2",sec:900},{name:"–ó–ê–ï–ó–î 3",sec:1200},{name:"–ó–ê–ï–ó–î 4",sec:300},{name:"–§–ò–ù–ò–®",sec:300}];

const $=s=>document.querySelector(s);
const tbody=$("#tbody"), stageName=$("#stageName"), timerEl=$("#timer");
const btnStart=$("#btnStart"), btnPause=$("#btnPause"), btnNext=$("#btnNext"), btnUndo=$("#btnUndo"), btnHard=$("#btnHard");
const stageChart=$("#stageChart"), chartHeader=$("#chartHeader"), stageTitle=$("#stageTitle"), bonusLayer=$("#bonusLayer");

function fresh(){return{teams:TEAM_NAMES.map((n,i)=>({id:i,name:n,color:COLORS[i],pts:0})),stage:0,remain:STAGES[0].sec,history:[]}}
function load(){try{const d=JSON.parse(localStorage.getItem(STORAGE_KEY)||"null");if(!d||!Array.isArray(d.teams)||d.teams.length!==TEAM_NAMES.length)return fresh();d.teams=d.teams.map((t,i)=>({id:i,name:TEAM_NAMES[i],color:COLORS[i],pts:Number(t?.pts)||0}));if(typeof d.stage!=="number")d.stage=0;if(typeof d.remain!=="number")d.remain=STAGES[d.stage].sec;if(!Array.isArray(d.history))d.history=[];return d}catch{return fresh()}}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state))}
let state=load(); let running=false,last=performance.now();
const fmt=s=>{s=Math.max(0,s|0);return String((s/60|0)).padStart(2,"0")+":"+String(s%60|0).padStart(2,"0")};
const sorted=()=>[...state.teams].sort((a,b)=>b.pts-a.pts);
function beep(f=880,d=120){try{const a=new (window.AudioContext||window.webkitAudioContext)(),o=a.createOscillator(),g=a.createGain();o.type="square";o.frequency.value=f;g.gain.value=.05;o.connect(g);g.connect(a.destination);o.start();setTimeout(()=>{o.stop();a.close()},d)}catch{}}
function stageBeep(){beep(660,120);setTimeout(()=>beep(880,150),160);setTimeout(()=>beep(520,180),360)}

/* === –†–µ–Ω–¥–µ—Ä —Å–ª–µ–≤–∞ (–±–µ–∑ –∫–æ–ª–æ–Ω–∫–∏ –æ—á–∫–æ–≤) === */
function updateBoard(){
  const s=sorted(); const leader=Math.max(1,...s.map(t=>t.pts),1);
  tbody.innerHTML="";
  s.forEach((t,idx)=>{
    const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=3; td.style.padding="0";
    const row=document.createElement("div"); row.className="row";
    const name=document.createElement("div"); name.className="name";
    const dot=document.createElement("span"); dot.className="badge"; dot.style.background=t.color;
    name.append(dot,document.createTextNode(t.name));
    const pos=document.createElement("div"); pos.className="pos"; pos.textContent=idx+1;
    const cell=document.createElement("div"); cell.className="progressCell";
    const btns=document.createElement("div"); btns.className="btns";
    ["+1","+5","+10","+15"].forEach(v=>{const b=document.createElement("button"); b.className="small"; b.textContent=v;
      b.onclick=()=>{add(t.id,parseInt(v)); spark(row, v==="+15"?"üü°":(v==="+10"?"‚ö°":(v==="+5"?"‚ú®":"‚ûï")));};
      btns.appendChild(b);
    });
    const pbar=document.createElement("div"); pbar.className="pbar"; const fill=document.createElement("span");
    fill.style.background=t.color; fill.style.width=(t.pts/leader*100).toFixed(1)+"%"; pbar.appendChild(fill);
    cell.append(btns,pbar);
    row.append(name,pos,cell); td.appendChild(row); tr.appendChild(td); tbody.appendChild(tr);
  });
}

/* === –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ç—Ç–∞–ø–∞ + –±–∞—Ä—ã –Ω–∞ –≤—Å—é –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫–∏ === */
function updateChart(){
  stageTitle.textContent=STAGES[state.stage].name;
  const s=sorted(); const leader=Math.max(1,...s.map(t=>t.pts),1);
  stageChart.innerHTML="";
  s.forEach(t=>{
    const row=document.createElement("div"); row.className="chart-row";
    const m=document.createElement("div"); m.className="meter"; const f=document.createElement("span");
    f.style.background=t.color; f.style.width=(t.pts/leader*100).toFixed(1)+"%"; m.appendChild(f);
    const v=document.createElement("div"); v.className="val"; v.textContent=t.pts; // –æ—á–∫–∏ —Ç–æ–ª—å–∫–æ —Å–ø—Ä–∞–≤–∞
    row.append(m,v); stageChart.appendChild(row);
  });
  syncHeaderHeight(); syncRowHeights();
}

/* === –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã—Å–æ—Ç === */
function syncHeaderHeight(){
  const thead=document.querySelector(".table thead");
  const h=thead?thead.getBoundingClientRect().height:0;
  chartHeader.style.height=h+"px";
}
function syncRowHeights(){
  const left=[...document.querySelectorAll("#tbody .row")];
  const right=[...document.querySelectorAll("#stageChart .chart-row")];
  const padV=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--row-pad-v"))||12;
  right.forEach((r,i)=>{
    const lh=left[i]?.offsetHeight||56;
    r.style.height=lh+"px";
    const meter=r.querySelector(".meter");
    meter.style.height=Math.max(10, lh - padV*2) + "px";  // –±–∞—Ä –Ω–∞ –≤—Å—é —Å—Ç—Ä–æ–∫—É (–º–∏–Ω—É—Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã)
    meter.style.borderRadius= (lh/2) + "px";
  });
}

/* === –≠—Ñ—Ñ–µ–∫—Ç –±–æ–Ω—É—Å–∞ === */
function spark(host,emoji){
  const r=host.getBoundingClientRect(), h=bonusLayer.getBoundingClientRect();
  const b=document.createElement("div"); b.className="bonus"; b.textContent=emoji;
  b.style.left=(r.left-h.left+r.width-60)+"px"; b.style.top=(r.top-h.top-8)+"px";
  bonusLayer.appendChild(b);
  b.animate([{transform:"translateY(0)",opacity:1},{transform:"translateY(-26px)",opacity:0}],{duration:650,easing:"ease-out"}).onfinish=()=>b.remove();
}

/* === –õ–æ–≥–∏–∫–∞ / —Ç–∞–π–º–µ—Ä / —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ === */
function add(id,d){const t=state.teams.find(x=>x.id===id); if(!t) return; t.pts+=d; state.history.push({ts:Date.now(),id,delta:d,stage:state.stage}); save(); render();}
function undo(){ // –æ—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
  const h=state.history.pop(); if(!h){return;}
  const t=state.teams.find(x=>x.id===h.id); if(t){ t.pts=Math.max(0, t.pts - h.delta); }
  save(); render();
}
function next(){if(state.stage<STAGES.length-1){state.stage++;state.remain=STAGES[state.stage].sec;running=false;document.getElementById("btnStart").disabled=false;stageBeep();save();render();}}
function hard(){if(confirm("–û–±–Ω—É–ª–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å?")){localStorage.removeItem(STORAGE_KEY);location.reload();}}

let tickLast=performance.now();
function tick(now){if(!running)return; if(now-tickLast>=1000){state.remain--; tickLast=now; timerEl.textContent=fmt(state.remain); if(state.remain<=3&&state.remain>0) beep(900,90); if(state.remain<=0){stageBeep(); running=false; document.getElementById("btnStart").disabled=false;} save();} requestAnimationFrame(tick);}
function start(){ if(STAGES[state.stage].name==="–§–ò–ù–ò–®")return; running=true; document.getElementById("btnStart").disabled=true; tickLast=performance.now(); requestAnimationFrame(tick);}
function pause(){ running=false; document.getElementById("btnStart").disabled=false;}

/* === –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è === */
function render(){ stageName.textContent=STAGES[state.stage].name; timerEl.textContent=fmt(state.remain); updateBoard(); updateChart(); }
function boot(){ render(); btnStart.onclick=start; btnPause.onclick=pause; btnNext.onclick=next; btnUndo.onclick=undo; btnHard.onclick=hard; window.addEventListener("resize",()=>{syncHeaderHeight(); syncRowHeights();}); }
document.readyState==="loading"?document.addEventListener("DOMContentLoaded",boot):boot();
})();
</script>
</body>
</html>
